<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Hartman</title>
    <script type="text/javascript" src="../JSLibrary/js/app.js"></script>
    <script src="js/js-windows.js"></script>

    <link href="assets/_css/style_hartmann.css" rel="stylesheet">
    <link href="js/libs/datetimepicker/jquery.datetimepicker.css" rel="stylesheet">
    <link href="assets/protocol/styles.css" rel="stylesheet">

    <script src="js/libs/datetimepicker/jquery.js"></script>
    <script src="js/libs/hammer/hammer.js"></script>
</head>


<body class="lock_screen">
<!--   <div id="console-log" style="white-space: normal;position: absolute;z-index: 999999;width:70vw;height:40vh;margin-left: 7rem;background:#eee;overflow:auto">LOG:</div>-->

<div class="wrapper">

    <!-- ______________________________________________________________________________________________________________ controls -->
    <nav>
        <div class="hartmann-logo"></div>

        <a class="burger-menu" href="#slide200">           <!-- main menu   -->
            <span></span>
            <span></span>
            <span></span>
        </a>

        <a class="hex-menu" href="#slide3"></a>            <!--  hexagon menu  -->
        <a class="information-btn" href="#slide202"></a>    <!--  information slide  -->
    </nav>


    <!-- ______________________________________________________________________________________________________________ content -->
    <section class="Stage_base showON" id="Stage_base">

        <article>

            <h1>
                <strong class="uppercase-text">{!POSITION_1}</strong>
            </h1>


            <div class="indication-phase filled-phase-black" id="indication-phase">
                <span class="indication"></span>
            </div>


            <div class="component">

                <div class="component_zone preparetion">
                    <h5>{!POSITION_2}</h5>
                    <div class="product_zone">
                        <!-- ......................... -->
                    </div>
                </div><!-- preparetion -->


                <div class="component_zone special">
                    <h5>{!POSITION_3}</h5>
                    <div class="product_zone">
                        <!-- ......................... -->
                    </div>
                </div><!-- special -->
            </div><!-- component -->


            <div class="recap-information">

                <div class="patient-number">
                    <label for="current-number">{!POSITION_4}</label>
                    <img src="assets/_images/patientnumber-container.png">
                    <input type="number" class="current-number" id="current-number">
                </div>

                <div class="note-textbox">
                    <textarea placeholder="Примечания..." id="comment"></textarea>
                </div>

                <div class="date-picker" id="date_button">
                    <p class="text-align-left">{!POSITION_5}</p>
                    <input type="hidden" class="date-input" id="date-input">
                    <span class="small-date-text"></span>
                    <img src="assets/_images/datepicker-icon.png">
                </div>
                <div class="destroy_date" id="destroy_date"></div>

                <ul class="check_set" id="include_cc">
                    <li>{!POSITION_13}</li>
                    <li>{!POSITION_14}</li>
                </ul>

                <div class="control-information">
                    <div class="submit-button disabled" id="submit-button_Save">
                        <p>{!POSITION_6}</p>
                    </div>
                    <!--      <div class="submit-button disabled" id="submit-button_Confirm">
                                     <p>{!POSITION_7}</p>
                           </div>  -->
                </div>
            </div><!-- recap-information -->


            <div class="contact-popup" id="contact-popup">
                <div class="close-btn"
                     onclick='document.getElementById("contact-popup").className = "contact-popup"'></div>
                <h1>{!POSITION_8}</h1>

                <form>
                    <fieldset>
                        <label for="email">{!POSITION_9}</label>
                        <input type="email" placeholder="email@address" id="email">
                    </fieldset>

                    <fieldset>
                        <label for="phone">{!POSITION_10}</label>
                        <input type="tel" placeholder="+XXXXXXX" id="phone">
                    </fieldset>

                    <fieldset>
                        <label for="fax">{!POSITION_11}</label>
                        <input type="tel" placeholder="+XXXXXXX" id="fax">
                    </fieldset>

                    <div class="submit-button-ok" id="submit-button-ok">{!POSITION_12}</div>
                </form>
            </div><!-- contact-popup -->

        </article>

    </section><!-- Stage_base -->


    <!-- _____________________________________________________________________________________________________________________________ -->

</div> <!-- wrapper -->

</body>


<script src="js/libs/datetimepicker/jquery.datetimepicker.full.min.js"></script>
<script src="js/js-common.js"></script>

<script>
    sessionStorage.setItem("storage_indexSlide", "211");

    var include_me_CC = false;
    var include_all_CC = false;
    var emailAttendee = [];
    var addressCCEmail = '';

    var visitReportId = "{!Visit_Report__c.Id}",
        contactId = "{!Contact.Id}",
        contactName = "{!Contact.Name}",
        accountId = "{!Account.Id}";

    const TEMPLATE_DEVELOPER_NAME = "RECAPGLOBAL";

    const A_PREFIX = "PROTOCOL",
        A_SEPARATOR = "-",
        A_EXTENSION = ".jpg";

    const SUBMIT_BTN_ID = "submit-button-ok",
        SAVE_BTN_ID = "submit-button_Save",
        SEND_BTN_ID = "submit-button_Confirm";

    var currentVisit = {};
    var currentContact = {};
    var currentVisitAttendee = [];
    var attendeeRecordTypes = {};
    var productRecordTypes = {};
    var visitProductsByProductId = {};
    var sharedMaterials = [];
    var selectedProducts = [];

    var lastScreenshot;

    $(document).ready(function () {

        var calcNavigateJump = sessionStorage.getItem('storage_calcNavigateJump');

        if( calcNavigateJump==="1") SlideNavigateJump(document.getElementById("Stage_base"), "212");

        document.addEventListener("WebViewJavascriptBridgeReady", function (event) {
            if (!visitReportId) {
                setLog("run NOR from visit!");
                return;
            }
            $.when(
                getVisit(),
                getRecordTypes("Visit_Product__c"),
                getVisitAttendee(),
                getRecordTypesAttendee("Visit_Attendee__c"),
                getSharedMaterials(),
                getVisitProducts()
            ).then(getContact).then(setUpData);
        });

        // ***********************************************************************
        $('#email, #phone, #fax').blur(function(){
            ValidForm()
        });
        // ***********************************************************************

    });

    // ***********************************************************************
    function ValidEmail() {
        var re = /^[\w-\.]+@[\w-]+\.[a-z]{2,5}$/i;
        var contactEmail = document.getElementById('email').value;
        var valid = re.test(contactEmail);

        if (valid) {
            console.log('Адрес эл. почты введен правильно!');
            document.getElementById('email').className = '';
        }else {
            if(contactEmail!=='') document.getElementById('email').className = 'error';
            else {
                valid = true;
                document.getElementById('email').className = '';
            }
        };
        return valid;
    };

    function ValidPhone() {
        var re = /^\+[\d]{4,14}\d$/;
        var contactPhone = document.getElementById('phone').value;
        var valid = re.test(contactPhone);

        if (valid) {
            console.log('Номер телефона введен правильно!');
            document.getElementById('phone').className = '';
        }else {
            if(contactPhone!=='') document.getElementById('phone').className = 'error';
            else {
                valid = true;
                document.getElementById('phone').className = '';
            }
        };
        return valid;
    };

    function ValidFax() {
        var re = /^\+[\d]{4,14}\d$/;
        var contactFax = document.getElementById('fax').value;
        var valid = re.test(contactFax);

        if (valid) {
            console.log('Номер fax введен правильно!');
            document.getElementById('fax').className = '';
        }else {
            if(contactFax!=='') document.getElementById('fax').className = 'error';
            else {
                valid = true;
                document.getElementById('fax').className = '';
            }
        };
        return valid;
    };


    function ValidForm() {
        console.log(ValidEmail());
        console.log(ValidPhone());
        console.log(ValidFax());

        if( ValidEmail() && ValidPhone() ) {

            if( document.getElementById('email').value==='' && document.getElementById('phone').value==='' ) document.getElementById('submit-button-ok').className = 'submit-button-ok disabled';
            else {
                if( ValidFax() ) document.getElementById('submit-button-ok').className = 'submit-button-ok';
                else             document.getElementById('submit-button-ok').className = 'submit-button-ok disabled';
            }
        }
        else document.getElementById('submit-button-ok').className = 'submit-button-ok disabled';
    };
    // ***********************************************************************


    function setUpData() {
        // setDescription();
        setNextVisitDate();
        getIncludeAllCCEmail();
        setClickListeners();
        setContactInfo();
        setSelectedProducts();
        enableElement(SAVE_BTN_ID);
        setLog('LOADING SUCCESS');
    }

    function setNextVisitDate() {
        var nextCallDate = formatDate(currentVisit.Next_Visit_Date__c);
        if (nextCallDate) {
            setLog('nextCallDate: ' + nextCallDate);
            $("#date-input").val(nextCallDate);
            $("span.small-date-text").html(nextCallDate);
        }
    }

    function setClickListeners() {
        document.getElementById(SAVE_BTN_ID).addEventListener("click", function (event) {
            doSave();
        });

        document.getElementById(SUBMIT_BTN_ID).addEventListener("click", function (event) {
            // ***********************************************************************
            if(this.className==="submit-button-ok") confirmContactInfoAndSend();
        });
    }

    function setSelectedProducts() {
        for (var keyCategory in dataPhaseMap[currentPhase].map) {
            if (dataPhaseMap[currentPhase].map[keyCategory].present === "" && dataPhaseMap[currentPhase].map[keyCategory].visual === "active") {
                prodIndex = dataPhaseMap[currentPhase].map[keyCategory].selected_prod;

                if (dataProduct[keyCategory][prodIndex].Id && !selectedProducts.includes(dataProduct[keyCategory][prodIndex].Id)) {
                    selectedProducts.push(dataProduct[keyCategory][prodIndex].Id);
                }
            }
        }
        setLog("selectedProducts=" + JSON.stringify(selectedProducts));
    }

    function setContactInfo() {
        if (!currentContact) return;
        if (currentContact.Email) $("#email").val(currentContact.Email);
        if (currentContact.Phone) $("#phone").val(currentContact.Phone);
        if (currentContact.Fax) $("#fax").val(currentContact.Fax);
    }

    function getVisit() {
        var defer = $.Deferred();

        let queryStr = "SELECT Id" +
            ", Next_Visit_Date__c" +
            // ", Description__c" +
            ", Contact__c" +
            " FROM Visit_Report__c" +
            " WHERE" +
            " Id='" + visitReportId + "'";

        ctm.query(queryStr, function (response) {
            if (response.success) {
                currentVisit = response.result[0];
                setLog("get visit success");
            } else {
                setLog("get visit error= " + JSON.stringify(response));
            }
            defer.resolve();
        });
        return defer.promise();
    };
    // =======================================
    // =======================================
    // =======================================
    // =======================================
    // =======================================
    // =======================================
    // =======================================
    // =======================================
    function getVisitAttendee() {
        var defer = $.Deferred();

        let queryStr = "SELECT Id" +
            ", PH_Participant__c" +
            ", Contact__c" +
            ", RecordTypeId" +
            " FROM Visit_Attendee__c" +
            " WHERE" +
            " Visit_Report__c='" + visitReportId + "'";

        ctm.query(queryStr, function (response) {
            if (response.success) {
                currentVisitAttendee = response.result;
                setLog("get visit success  !!!!!Visit_Attendee!!!!"+ JSON.stringify(currentVisitAttendee));
            } else {
                setLog("get visit error= " + JSON.stringify(response));
            }
            defer.resolve();
        });
        return defer.promise();
    };


    function getRecordTypesAttendee(sObject) {
        var defer = $.Deferred();

        var queryStr = "SELECT Id" +
            ", DeveloperName" +
            ", SObjectType" +
            " FROM RecordType" +
            " WHERE" +
            " SObjectType = '" + sObject + "'";

        ctm.query(queryStr, function (response) {
            attendeeRecordTypes = {};
            var inputData = response.result;

            for (var x = 0; x < inputData.length; x++) {
                attendeeRecordTypes[inputData[x].Id] = inputData[x].DeveloperName;
            };
            setLog(" !!!!!RecordTypesAttendees!!!!"+ JSON.stringify(attendeeRecordTypes));
            defer.resolve();
        });
        return defer.promise();
    };


    function getAttendeeEmail(objType, objID) {
        var defer = $.Deferred();
        let resultEmail = {};

        let queryStr = "SELECT Id" +
            ", Email" +
            " FROM "+objType +
            " WHERE" +
            " Id='" + objID + "'";

        ctm.query(queryStr, function (response) {
            if (response.success) {
                resultEmail = response.result;
                setLog("resultEmail!!!!! " + JSON.stringify(resultEmail));
                setLog("resultEmail!!!!! " + response.result[0].Email);

                if(response.result[0].Email) {
                    emailAttendee.push(response.result[0].Email);
                };
                setLog("get success getAttendeeEmail!!!!! = " + JSON.stringify(emailAttendee));
            } else {
                setLog("get Attendee error= " + JSON.stringify(response));
            };
            defer.resolve();
        });
        return defer.promise();
    };


    function getIncludeAllCCEmail() {
        let recordType,
            idAttendee;

        for(let n = 0; n<currentVisitAttendee.length; n++) {
            recordType = attendeeRecordTypes[currentVisitAttendee[n].RecordTypeId];

            if( currentVisitAttendee[n].Contact__c ) {
                idAttendee = currentVisitAttendee[n].Contact__c;
                recordType = "Contact";
                setLog("recordType!!!!!====" + recordType);
                setLog("idAttendee!!!!!====" + idAttendee);
                getAttendeeEmail(recordType, idAttendee);
            };

            if( currentVisitAttendee[n].PH_Participant__c ) {
                idAttendee = currentVisitAttendee[n].PH_Participant__c;
                recordType = "User";
                setLog("recordType!!!!!====" + recordType);
                setLog("idAttendee!!!!!====" + idAttendee);
                getAttendeeEmail(recordType, idAttendee);
            };
        };
    };
    // =======================================
    // =======================================
    // =======================================
    // =======================================
    // =======================================
    // =======================================
    // =======================================
    // =======================================


    function getContact() {
        var defer = $.Deferred();

        if (!currentVisit || !currentVisit.Contact__c) {
            defer.resolve();
            return;
        }

        let queryStr = "SELECT Id" +
            ", Email" +
            ", Phone" +
            ", Fax" +
            " FROM Contact" +
            " WHERE" +
            " Id='" + currentVisit.Contact__c + "'";

        ctm.query(queryStr, function (response) {
            if (response.success) {
                currentContact = response.result[0];
                setLog("get Contact success");
            } else {
                setLog("get Contact error= " + JSON.stringify(response));
            }
            defer.resolve();
        });

        return defer.promise();
    }

    function getRecordTypes(sObject) {
        var defer = $.Deferred();

        var queryStr = "SELECT Id" +
            ", DeveloperName" +
            ", SObjectType" +
            " FROM RecordType" +
            " WHERE" +
            " SObjectType = '" + sObject + "'";

        ctm.query(queryStr, function (response) {
            productRecordTypes = {};

            var inputData = response.result;

            for (var z = 0; z < inputData.length; z++) {
                productRecordTypes[inputData[z].DeveloperName] = inputData[z].Id;
            }
            defer.resolve();
        });

        return defer.promise();
    }

    function getSharedMaterials() {
        var defer = $.Deferred();

        var queryStr = "SELECT Id" +
            ", ScreenshotId__c" +
            ", SolutionNumber__c" +
            " FROM SharedMaterials__c" +
            " WHERE" +
            " VisitReportId__c='" + visitReportId + "'";

        ctm.query(queryStr, function (response) {
            let materials = response.result;
            for (let i = 0; i < materials.length; i++) {
                sharedMaterials.push(materials[i].Id);
            }
            setLog("getSharedMaterials=" + sharedMaterials.length);
            defer.resolve();
        });

        return defer.promise();
    }

    function getVisitProducts() {
        var defer = $.Deferred();

        var queryStr = "SELECT Id" +
            ", Hartmann_Product_Lookup__c" +
            ", Solution_Product__c" +
            ", Number_of_Patients__c" +
            " FROM Visit_Product__c" +
            " WHERE" +
            " Visit_Report__c='" + visitReportId + "'";

        ctm.query(queryStr, function (response) {
            let products = response.result;
            for (let i = 0; i < products.length; i++) {
                visitProductsByProductId[products[i].Hartmann_Product_Lookup__c] = products[i];
                setPatientsNumber(products[i].Number_of_Patients__c);
            }
            setLog("visitProductsByProductId=" + Object.keys(visitProductsByProductId).length);
            defer.resolve();
        });

        return defer.promise();
    }

    function getPresentations() {
        let presentations = [];
        let brochures = JSON.parse(localStorage.getItem("storage_dataInform")).Brochures;
        for (let i = 0; i < brochures.length; i++) {
            if (brochures[i].selected && !presentations.includes(brochures[i].applicationCode)) {
                presentations.push(brochures[i].applicationCode);
            }
        }
        setLog("presentations= " + presentations.join(","));
        return presentations.join(",");
    }

    function getPatientsNumber() {
        return +($("#current-number").val());
    }

    function setPatientsNumber(value) {
        if(value) {
            $("#current-number").val(value);
        }
    }

    function getNextVisitDate() {
        let date = $("#date-input").val();
        if(!date) {
            return undefined;
        }
        let UTCDate = new Date(date);
        let y = UTCDate.getUTCFullYear();
        let m = ("0" + (UTCDate.getUTCMonth() + 1)).substr(-2);
        let d = ("0" + UTCDate.getUTCDate()).substr(-2);
        let h = ("0" + UTCDate.getUTCHours()).substr(-2);
        let min = ("0" + UTCDate.getUTCMinutes()).substr(-2);

        return y + "-" + m + "-" + d + "T" + h + ":" + min + ":00.000Z";
    }


    function getDescription() {
        let description = "";
        if(currentVisit.Description__c) description = currentVisit.Description__c;
        if($("#comment").val()) description = description + "\n" + $("#comment").val();
        return description;
        // return $("#comment").val() || "";
    };


    function setDescription() {
        let description = currentVisit.Description__c || "";
// $("#comment").val(description);
    }

    function disableElement(elementId) {
        $("#" + elementId).addClass("disabled");
    }

    function enableElement(elementId) {
        $("#" + elementId).removeClass("disabled");
    }

    function doSave() {
        setLog("-----", true);
//disableElement(SAVE_BTN_ID);
//Save the screenshot to the Notes & Attachments of the Visit Report
//Create new record Shared Materials
        takeScreenshot();

//Create new / update existing Visit Topics for every product displayed on the slide.
        updateVisitTopics();

//Update Visit Report
        updateVisit();

//enableElement(SAVE_BTN_ID);
        enableElement(SEND_BTN_ID);
    }

    function confirmContactInfoAndSend() {
        saveContact();
        closeContactInfoPopUp();
        showSendEmailForm();
    }

    function closeContactInfoPopUp() {
        $('.contact-popup').removeClass("open");
    }

    function saveContact() {
        if (!currentContact) return;

        let email = $("#email").val(),
            phone = $("#phone").val(),
            fax = $("#fax").val();

        let contacts = [];
        let contact = {
            SObject: "Contact",
            Id: currentContact.Id
        };

        if (email !== currentContact.Email) contact.Email = email;
        if (phone !== currentContact.Phone) contact.Phone = phone;
        if (fax !== currentContact.Fax) contact.Fax = fax;

        contacts.push(contact);

        ctm.update(contacts, function (response) {
            if (response.success) {
                getContact();
                setLog("Update Contact success");
            } else {
                setLog("Update Contact error= " + JSON.stringify(response));
            }
        });
    }

    function showSendEmailForm() {
        if (sharedMaterials.length === 0) return;

        var email = $("#email").val();
//to, cc, templateId, sharedMaterialsId, callback
        ctm.previewEmail(email, null, TEMPLATE_DEVELOPER_NAME, sharedMaterials[sharedMaterials.length - 1]);
    }

    function createSharedMaterials() {
        let sMaterials = [];
        sMaterials.push({
            SObject: "SharedMaterials__c",
            VisitReportId__c: visitReportId,
            ScreenshotId__c: lastScreenshot ? lastScreenshot.Name : null,
            SolutionNumber__c: (sharedMaterials.length + 1),
            ApplicationIds__c: getPresentations(),
            IncludeMeToTheCC__c: include_me_CC,
            IncludeAllPHParticipants_to_the_CC__c: include_all_CC,
            AddressCC__c: addressCCEmail,
        });
        setLog('sMaterials: ' + JSON.stringify(sMaterials));

        ctm.create(sMaterials, function (response) {
            if (response.success) {
                setLog("shared material created= " + response.result[0].Id);
                sharedMaterials.push(response.result[0].Id);
            } else {
                setLog("shared material error= " + JSON.stringify(response));
            }
        });
    }

    function updateVisitTopics() {
        for (let i = 0; i < selectedProducts.length; i++) {
            if (visitProductsByProductId.hasOwnProperty(selectedProducts[i])) {
                updateVisitProduct(selectedProducts[i]);
            } else {
                createVisitProduct(selectedProducts[i]);
            }
        }
    }

    function updateVisitProduct(productId) {

        visitProductsByProductId[productId].Number_of_Patients__c = getPatientsNumber();

        let visitProducts = [];
        let visitProduct = {
            SObject: "Visit_Product__c",
            Id: visitProductsByProductId[productId].Id,
            Number_of_Patients__c: visitProductsByProductId[productId].Number_of_Patients__c
        };

        visitProducts.push(visitProduct);

        ctm.update(visitProducts, function (response) {
            if (response.success) {
                setLog("Update visit product success");
            } else {
                setLog("Update visit product error= " + JSON.stringify(response));
            }
        });
    }

    function createVisitProduct(productId) {
        let visitProducts = [];
        let visitProduct = {
            SObject: "Visit_Product__c",
            Visit_Report__c: visitReportId,
            RecordTypeId: productRecordTypes["Products"],
            Hartmann_Product_Lookup__c: productId,
            Number_of_Patients__c: getPatientsNumber()
        };

        visitProducts.push(visitProduct);

        ctm.create(visitProducts, function (response) {
            if (response.success) {
                visitProduct.Id = response.result[0];
                visitProductsByProductId[productId] = visitProduct;
                setLog("Create visit topic success");
            } else {
                setLog("Create visit topic error= " + JSON.stringify(response));
            }
        });
    }

    function updateVisit() {
        let visits = [];
        let nextVisitDate = getNextVisitDate()
            // description = getDescription();

        let visit = {
            SObject: "Visit_Report__c",
            Id: visitReportId
        };
        if($("span.small-date-text").html() == ""){
            visit.Next_Visit_Date__c = null;
        }else if(nextVisitDate){
            visit.Next_Visit_Date__c = nextVisitDate;
        }
        // if(description) visit.Description__c = description;

        setLog("Visit= " + JSON.stringify(visit));

        visits.push(visit);

        ctm.update(visits, function (response) {
            if (response.success) {
                currentVisit.Next_Visit_Date__c = visit.Next_Visit_Date__c;
                // currentVisit.Description__c = visit.Description__c;
                currentVisit.SolutionNumber__c = visit.SolutionNumber__c;
                setLog("Update Visit success");
            } else {
                setLog("Update Visit error= " + JSON.stringify(response));
            }
        });
    }

    function takeScreenshot() {
        toggleUnnecessaryElements();

        setTimeout(function(){
            toggleUnnecessaryElements();
            ctm.screenshot(function (result) {
//add attachment to the visit THEN Creat shared material with this screenshot
                addAttachment(result).then(createSharedMaterials);
            });
        }, 200);
    }

    function toggleUnnecessaryElements() {
        $("nav").toggle();
        $(".control-information").toggle();
    }

    function addAttachment(url) {
        var defer = $.Deferred();

        let now = new Date(),
            photoName = A_PREFIX + A_SEPARATOR +
                now.getDate() + A_SEPARATOR +
                now.getMonth() + A_SEPARATOR +
                now.getFullYear() + A_SEPARATOR +
                generateUniqueCode(5) + A_EXTENSION;

        var newAttach = {
            name: photoName,
            parentId: visitReportId,
            file_url: url
        };

        ctm.storeFile(newAttach, function (response) {
            if (response.success) {

                lastScreenshot = {
                    Id: response.id,
                    Name: photoName
                }
                setLog("Screenshot saved =" + lastScreenshot.Name);
            } else {
                setLog("upload attachment error= " + JSON.stringify(response));
            }

            defer.resolve();
        });

        return defer.promise();
    }

    function formatDate(date) {
        let fromTwo;
        let hour;
        let min;
        if (!date) return undefined;

        let from = date.split("T")[0].split("-");
        if(from.length == 3){
            fromTwo = date.split("T")[1].split(":");
            hour = fromTwo[0];
            min = fromTwo[1];
        }else{
            hour = from[3];
            min = from[4];
        }
        let year = from[0];
        let month = from[1];
        let day = from[2];

        return year + "/" + month + "/" + day + " " + hour + ":" + min;
    }

    function generateUniqueCode(stringLength) {

        var str = "",
            letters = "abcdefghijklmnopqrstuvwxyz" +
                "ABCDEFGHIJKLMNOPQRSTUVWXYZ" +
                "0123456789",
            lettersLength = letters.length;

        while (str.length < stringLength) {
            str += letters[Math.random() * lettersLength | 0];
        }

        return str;
    }

    function setLog(message, resetLog) {

        let logger = document.getElementById("console-log");
        if (!logger) return;

        if (resetLog) {
            logger.innerHTML = message;
        } else {
            logger.innerHTML = logger.innerHTML + "\n" + message;
        }
    };

    // =========================================================
    // =========================================================
    // =========================================================

    var currentPhase = localStorage.getItem('storage_currentPhase');

    var dataProduct = JSON.parse(localStorage.getItem('storage_dataProduct'));
    var dataPhaseMap = JSON.parse(localStorage.getItem('storage_dataPhaseMap'));

    var typeLoad = localStorage.getItem('storage_typeLoad');


    var input_Date, input_NumberPatient, input_Note;


    var prodCat, prodIndex;

    var arrayPhase = {
        "black": "Black",
        "yellow": "Yellow",
        "red": "Red",
        "pink": "Pink",
        "white": "",
    };



    // =================================================================================================== Load Protocol
    function LoadProtocol() {
        var preparetionHTML = '';
        var specialHTML = '';

        var preparetionCounter = 0;
        var specialCounter = 0;

        for(var keyCategory in dataPhaseMap[currentPhase].map ) {

            if( dataPhaseMap[currentPhase].map[keyCategory].present==='' && dataPhaseMap[currentPhase].map[keyCategory].visual==="active" ) {
                prodCat = keyCategory;
                prodIndex = dataPhaseMap[currentPhase].map[keyCategory].selected_prod;

                if( dataProduct[prodCat][prodIndex].range==="preparetion" ) {
                    preparetionCounter++;
                    preparetionHTML += '<div class="hexagon small '+ dataProduct[prodCat][prodIndex].hexagon_name +'">' +
                        '<img src="'+ dataProduct[prodCat][prodIndex].packshot +'"> ' +
                        '<p class="product-name">'+ dataProduct[prodCat][prodIndex].name +'</p>' +
                        '</div>';
                }else {
                    specialCounter++;
                    specialHTML += '<div class="hexagon small '+ dataProduct[prodCat][prodIndex].hexagon_name +'">' +
                        '<img src="'+ dataProduct[prodCat][prodIndex].packshot +'"> ' +
                        '<p class="product-name">'+ dataProduct[prodCat][prodIndex].name +'</p>' +
                        '</div>';
                };
            };

        };

        $(".preparetion .product_zone").html(preparetionHTML);
        $(".special .product_zone").html(specialHTML);

        if( preparetionCounter===0 ) $(".component").addClass("special_only");
        if( specialCounter===0 ) $(".component").addClass("preparetion_only");

        if( preparetionCounter===1 ) $(".component_zone.preparetion").addClass("single_hex");
        if( specialCounter===1 ) $(".component_zone.special").addClass("single_hex");

    };



    // ============================================================================================== Load Protocol Therapy
    function LoadProtocolTherapy() {

        var preparetionHTML = '<div class="product-box box">' +
            '<div class="component-hexagon text-hexagon">\n' +
            '<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 245.717 271.918" class="svg">' +
            '<g><path d="M20.4,57.36c-.738.433-16.82,10.094-16.82,29.14v98.926c0,.786.3,19.589,16.815,29.131l85.653,49.456c.683.389,17.106,9.535,33.622,0l85.655-49.457c.678-.4,16.814-10.053,16.814-29.13V86.5c0-.786-.3-19.59-16.815-29.137L139.669,7.907c-.684-.39-17.106-9.541-33.621,0Z" transform="translate(0 0)" class="hexagon-stroke" style="fill: rgb(236, 170, 59); stroke: none; stroke-width: 0;"></path>\n' +
            '</g></svg>' +
            '<div class="inner_hex flex-V-center-center">' +
            '<div>Hydro <strong>Therapy</strong></div>' +
            '</div></div>' +
            '<div class="main-product-hexagon">' +
            '<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 245.717 271.918" class="svg">' +
            '<g><path d="M20.4,57.36c-.738.433-16.82,10.094-16.82,29.14v98.926c0,.786.3,19.589,16.815,29.131l85.653,49.456c.683.389,17.106,9.535,33.622,0l85.655-49.457c.678-.4,16.814-10.053,16.814-29.13V86.5c0-.786-.3-19.59-16.815-29.137L139.669,7.907c-.684-.39-17.106-9.541-33.621,0Z" transform="translate(0 0)" class="hexagon-stroke" style="fill: none; stroke: rgb(92, 196, 225); stroke-width: 3px;"></path>\n' +
            '</g></svg>' +
            '<a class="inner_hex flex-V-center-center" href="#slide1111111111111111111">' +
            '<img src="assets/_images/packshots/hydroclean_plus.jpg" class="img-container">' +
            '<div>Hydro<span style="color:#5cc4e1;">Clean<sup>®</sup> plus</span></div></a></div>' +
            '<div class="main-product-hexagon">\n' +
            '<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 245.717 271.918" class="svg">' +
            '<g><path d="M20.4,57.36c-.738.433-16.82,10.094-16.82,29.14v98.926c0,.786.3,19.589,16.815,29.131l85.653,49.456c.683.389,17.106,9.535,33.622,0l85.655-49.457c.678-.4,16.814-10.053,16.814-29.13V86.5c0-.786-.3-19.59-16.815-29.137L139.669,7.907c-.684-.39-17.106-9.541-33.621,0Z" transform="translate(0 0)" class="hexagon-stroke" style="fill: none; stroke: rgb(92, 196, 225); stroke-width: 3px;"></path>\n' +
            '</g></svg>' +
            '<a class="inner_hex flex-V-center-center" href="#slide1111111111111111111">' +
            '<img src="assets/_images/packshots/hydrotac.jpg" class="img-container">' +
            '<div>Hydro<span style="color:#5cc4e1;">Tac<sup>®</sup></span></div></a></div>' +
            '<div class="component-hexagon connect-hexagon">' +
            '<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 245.717 271.918" class="svg">' +
            '<g><path d="M20.4,57.36c-.738.433-16.82,10.094-16.82,29.14v98.926c0,.786.3,19.589,16.815,29.131l85.653,49.456c.683.389,17.106,9.535,33.622,0l85.655-49.457c.678-.4,16.814-10.053,16.814-29.13V86.5c0-.786-.3-19.59-16.815-29.137L139.669,7.907c-.684-.39-17.106-9.541-33.621,0Z" transform="translate(0 0)" class="hexagon-stroke" style="fill: rgb(87, 86, 86); stroke: none; stroke-width: 0;"></path>\n' +
            '</g></svg>' +
            '<div class="flex flex-V-center-center">+</div></div>' +
            '<div class="component-hexagon colored-hexagon hexagon-colored-1">' +
            '<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 245.717 271.918" class="svg">' +
            '<g><path d="M20.4,57.36c-.738.433-16.82,10.094-16.82,29.14v98.926c0,.786.3,19.589,16.815,29.131l85.653,49.456c.683.389,17.106,9.535,33.622,0l85.655-49.457c.678-.4,16.814-10.053,16.814-29.13V86.5c0-.786-.3-19.59-16.815-29.137L139.669,7.907c-.684-.39-17.106-9.541-33.621,0Z" transform="translate(0 0)" class="hexagon-stroke" style="fill: rgb(0, 0, 0); stroke: none; stroke-width: 0;"></path>\n' +
            '</g></svg></div>' +
            '<div class="component-hexagon colored-hexagon hexagon-colored-2">' +
            '<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 245.717 271.918" class="svg">' +
            '<g><path d="M20.4,57.36c-.738.433-16.82,10.094-16.82,29.14v98.926c0,.786.3,19.589,16.815,29.131l85.653,49.456c.683.389,17.106,9.535,33.622,0l85.655-49.457c.678-.4,16.814-10.053,16.814-29.13V86.5c0-.786-.3-19.59-16.815-29.137L139.669,7.907c-.684-.39-17.106-9.541-33.621,0Z" transform="translate(0 0)" class="hexagon-stroke" style="fill: rgb(247, 168, 0); stroke: none; stroke-width: 0;"></path>\n' +
            '</g></svg></div>' +
            '<div class="component-hexagon colored-hexagon hexagon-colored-3">' +
            '<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 245.717 271.918" class="svg">' +
            '<g><path d="M20.4,57.36c-.738.433-16.82,10.094-16.82,29.14v98.926c0,.786.3,19.589,16.815,29.131l85.653,49.456c.683.389,17.106,9.535,33.622,0l85.655-49.457c.678-.4,16.814-10.053,16.814-29.13V86.5c0-.786-.3-19.59-16.815-29.137L139.669,7.907c-.684-.39-17.106-9.541-33.621,0Z" transform="translate(0 0)" class="hexagon-stroke" style="fill: rgb(229, 49, 13); stroke: none; stroke-width: 0;"></path>\n' +
            '</g></svg></div>' +
            '<div class="component-hexagon colored-hexagon hexagon-colored-4">' +
            '<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 245.717 271.918" class="svg">' +
            '<g><path d="M20.4,57.36c-.738.433-16.82,10.094-16.82,29.14v98.926c0,.786.3,19.589,16.815,29.131l85.653,49.456c.683.389,17.106,9.535,33.622,0l85.655-49.457c.678-.4,16.814-10.053,16.814-29.13V86.5c0-.786-.3-19.59-16.815-29.137L139.669,7.907c-.684-.39-17.106-9.541-33.621,0Z" transform="translate(0 0)" class="hexagon-stroke" style="fill: rgb(214, 0, 95); stroke: none; stroke-width: 0;"></path>\n' +
            '</g></svg></div>' +
            '</div>';


        $(".preparetion .product_zone").html(preparetionHTML);

        $(".component").addClass("preparetion_only").addClass("preparetion_extra");

    };


    // ==============================================================================================
    // ==============================================================================================
    // ==============================================================================================
    $(document).ready(function(){

// ==============================================================================================  SETUP
        document.getElementById("indication-phase").className = 'indication-phase filled-phase-'+currentPhase ;

        if( currentPhase!=="white" ) $(".indication-phase .indication").html("Phase<br>"+arrayPhase[currentPhase]);

        if( typeLoad==="therapy" ) {
            LoadProtocolTherapy();
        }else {
            LoadProtocol();
        };


// ==================================================================================================== form
        $('#current-number').change(function(){
            input_NumberPatient = $('#current-number').val();
        });

        $('#comment').change(function(){
            input_Note = $('#comment').val();
        });


        $('#date-input').datetimepicker({
            step: 30,
            minTime:'6:00',
            defaultDate: new Date(),
            onShow:function(dp,$input){                                                                                     console.log("onShow");
                if( /iPhone|iPad|iPod/i.test(navigator.userAgent) ) {
                    $('.xdsoft_timepicker').addClass("ios_style");
                }else {
                    $('.xdsoft_timepicker').addClass("windows_style");
                };
            },
            onChangeDateTime:function(dp,$input){
                input_Date = $input.val();
                $('span.small-date-text').html(input_Date);

                var d = $('#date-input').datetimepicker('getValue');                                                        console.log(d); console.log(new Date());
            },
            onClose:function(dp,$input){
                $('#date-input').datetimepicker('reset');
                input_Date = $input.val();
                $('span.small-date-text').html(input_Date);
            }
        });

        document.getElementById("date_button").addEventListener('click', function(event) {
            $('#date-input').datetimepicker('show'); //support hide,show and destroy command
        });

        document.getElementById("destroy_date").addEventListener('click', function(event) {
            $('span.small-date-text').html('');
            $('#date-input').val('');
        });


// =========================================================== check_set
        $('#include_cc li').on("click", function (e) {
            let currentBtn = $(this);
            let currentemailAttendee = "";

            addressCCEmail = '';
            currentBtn.toggleClass("active");

            if( $('#include_cc li:first-child').hasClass("active") ) {
                include_me_CC = true;
                addressCCEmail = "{!User.Email}";
            }else {
                include_me_CC = false;
            };

            if( $('#include_cc li:last-child').hasClass("active") ) {   //emailAttendee
                include_all_CC = true;
                setLog("include_all_cc click emailAttendee!!!!!" + JSON.stringify(emailAttendee));

                currentemailAttendee = emailAttendee.join(',');
                if(currentemailAttendee) addressCCEmail += "," + currentemailAttendee;
            }else {
                include_all_CC = false;
            };
        });

// ==================================================================================================== popup
        document.getElementById("submit-button_Confirm").addEventListener('click', function(event) {
            $('.contact-popup').addClass("open");
            ValidForm();
        });


// ==============================================================================================

    });
</script>

</html>